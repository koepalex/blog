<!doctype html><html lang=de-de><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content><meta property="og:type" content="article"><meta property="og:image" content="https://www.alexander-koepke.de//koepalex.logo.gif"><meta property="twitter:image" content="https://www.alexander-koepke.de//koepalex.logo.gif"><meta name=title content="Neues vom GC in .NET 4.0 und 4.5"><meta property="og:title" content="Neues vom GC in .NET 4.0 und 4.5"><meta property="twitter:title" content="Neues vom GC in .NET 4.0 und 4.5"><meta name=description content="Technical articles, the Universe and the all the rest"><meta property="og:description" content="Technical articles, the Universe and the all the rest"><meta property="twitter:description" content="Technical articles, the Universe and the all the rest"><meta property="twitter:card" content="summary"><meta name=keyword content><link rel="shortcut icon" href=/img/favicon.ico><title>Neues vom GC in .NET 4.0 und 4.5 | </title><link rel=canonical href=/post/2013-10-21-neues-vom-gc-in-net-4-0-und-4-5/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script><script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/></a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/ai/ml/>ai/ml</a></li><li><a href=/categories/dotnet/>dotnet</a></li><li><a href=/categories/miscellaneous/>miscellaneous</a></li><li><a href=/categories/opc-ua/>opc ua</a></li><li><a href=/categories/til/>til</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/koepalex.logo.gif)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/dotnet title=dotnet>dotnet
</a><a class=tag href=/tags/gc title=gc>gc
</a><a class=tag href=/tags/largeobjectheapcompactionmode title=largeobjectheapcompactionmode>largeobjectheapcompactionmode
</a><a class=tag href=/tags/loh title=loh>loh
</a><a class=tag href=/tags/lowlatency title=lowlatency>lowlatency
</a><a class=tag href=/tags/soh title=soh>soh
</a><a class=tag href=/tags/sustainedlowlatency title=sustainedlowlatency>sustainedlowlatency</a></div><h1>Neues vom GC in .NET 4.0 und 4.5</h1><h2 class=subheading></h2><span class=meta>Posted by
on
Monday, October 21, 2013</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>Heute möchte ich etwas über Erneuerungen im .NET 4.0 / 4.5 sprechen. Das genannte bezieht sich auf den Workstation Garbage-Collector. Die Informationen für den Server Garbage-Collector entnehmen sie bitte den Links. Beginnen wir jedoch zunächst mit einer kurzen Auffrischung.</p><h3 id=wiederholung>Wiederholung</h3><p>Das .NET Framework unterteilt seinen Heap in verschiedene Generationen.</p><ul><li>In der <strong>Gen0</strong> werden fast alle Objekte erstellt. Die Anfangsgröße beträgt rund 256KB.</li><li>In der <strong>Gen1</strong> werden Objekte gespeichert die <em>eine</em> Garbage-Collection überlebt haben. Die Anfangsgröße beträgt rund 2 MB.</li><li>In der <strong>Gen2</strong> werden Objekte gespeichert die <em>mehr als eine</em> Garbage-Collection überlebt haben Die Anfangsgröße beträgt 10 MB.</li></ul><p>Die soeben genannten Anfangsgrößen können zur Laufzeit variiert werden. Am stärksten wird sich i.A. die Größe der Gen2 verändern (wachsen), da die Gen2 als <em>Endlager</em> für alle länger benötigten Objekte dient.</p><p>Die Gen2 teilt sich logisch in zwei Bereiche auf:</p><ul><li><strong>SOH</strong> der <em>Small Object Heap</em> dieser enthält alle Objekte die durch mindestens zwei Garbage-Collections hierher verschoben wurden.</li><li><strong>LOH</strong> der <em>Large Object Heap</em> welcher alle Objekte mit einer Größe größer gleich 85 KB enthält.</li></ul><p>Eine Garbage-Collection läuft in zwei Schritten ab. Die erste Phase <em>Mark</em> markiert alle Objekte die nicht mehr benötigt werden. Im zweiten Schritt <em>Sweep</em> wird der Speicher der markierten Objekte freigegeben. Um zu entscheiden, ob ein Objekt noch benötigt wird, sucht der GC Wurzeln <em>Roots</em>. Wurzeln können u.a. statische Felder, Methodenparameter, lokale Variablen oder CPU Register sein. Hat ein Objekt (oder eine Gruppe von Objekten) keinen Verweis auf eine Wurzel ist es aus dem Programmcode nicht mehr zugreifbar und kann aus dem Speicher entfernt werden. Sollte ein Objekt eine Garbage-Collection überleben und noch nicht in Gen2 sein, wird es um eine Generation verschoben.</p><p>Zu einer Fragmentierung der 0. und 1. Generation kann es bei diesem Entwurf nicht kommen. Denn ein Objekt wird entweder verschoben (von 0 nach 1 bzw. von 1 nach 2) oder gelöscht.</p><p>Der SOH (der Gen2) kann über die Zeit fragmentieren, deswegen wird in der Sweep-Phase der Heap zusammen gepackt (komprimiert/defragmentiert). Für eine solche Garbage-Collection wird der Main-Thread vom Garbage-Collector-Thread unterbrochen. <strong>Der LOH kann über die Zeit auch fragmentieren hier wird jedoch keine Defragmentierung durchgeführt.</strong> Das kann zu Speicherknappheit (OutOfMemory-Abstürzen) in .NET Programmen führen, obwohl insgesamt genügend freier Speicher vorhanden ist.</p><h3 id=net-40>.NET 4.0</h3><p>Die Gen0 und Gen1 arbeitet der Garbage-Collector unverändert ab. Die Gen2-Collection läuft jetzt jedoch meist im Hintergrund. Diese <strong>nicht blockierende Garbage-Collection</strong> hat die Einschränkung, dass der SOH dabei nicht defragmentiert wird. Für eine Defragmentierung ist eine blockierende Garbage-Collection notwendig. Die Zeit in welcher die Garbage-Collection ein Programm blockiert wurde dadurch drastisch reduziert. <a href=http://msdn.microsoft.com/en-US/library/ee787088.aspx>Mehr zur Hintergrund Garbage-Collection</a></p><hr><p>Eine weitere Optimierung stellt der <strong>LowLatency</strong> Modus dar, dieser unterbindet jegliche Gen2-Collection <em>komplett</em>. Nur eine <em>low memory</em> Notifikation des Betriebssystems oder ein expliziter Aufruf von GC.Collect mit 2 als Parameter haben eine Gen2-Collection zur Folge. Das aktivieren des LowLatency-Modus ist nur für besonders Zeitkritische Aufgaben zu empfehlen und sollte deshalb nur vorübergehend genutzt werden. Aktiviert wurde der neue Modus mittels:</p><p><code>GCSettings.LatencyMode = GCLatencyMode.LowLatency;</code></p><p><a href=http://msdn.microsoft.com/en-us/library/bb384202.aspx>Weiterführende Dokumentation zum LowLatency Mode</a></p><h3 id=net-45>.NET 4.5</h3><p>Der Latency-Modus wurde um die Option <strong>SustainedLowLatency</strong> erweitert, welche im Gegensatz zum <em>LowLatency</em> zusätzliche Hintergrund Gen2-Collections durchführt. Der neue Modus ist dazu geeignet das Programm über einen längeren Zeitraum im LowLatency laufen zulassen. Der SustainedLowLatency Modus wurde übrigens von Microsoft auf für .NET 4.0 mit dem <a href=http://support.microsoft.com/kb/2600211>Update 3</a> nachgeliefert.</p><hr><p>Das Garbage-Collector-Team hat auch etwas für den LOH getan unter anderem das finden von freien Speicherblöcken bei einer Allokation verbessert:</p><blockquote><p>In preparation for LOH allocation requests, the GC builds up a list of free (available) memory blocks after a collection. As part of an allocation, the GC consults this these free memory blocks one by one to determine if any block in the list will satisfy the allocation. If a given memory block is a candidate, it is used for the allocation. In earlier releases of the .NET Framework, once a memory block was rejected as a candidate for an allocation, it was removed as a candidate for subsequent allocations.</p></blockquote><hr><p>Den größten Nutzen werden große Programme wohl davon haben, dass es jetzt möglich ist den <strong><em>LOH zu Komprimieren</em></strong>! Dazu ist nur folgender Quelltext notwendig:</p><p><code>GCSettings.LargeObjectHeapCompactionMode = GCLargeObjectHeapCompactionMode.CompactOnce; //force Gen0 to Gen2 blocking GC GC.Collect();</code></p><hr><p>Für weitere Verbesserungen des wie <strong>Allokation von Objekten über 2 GB</strong> siehe <a href=http://blogs.msdn.com/b/dotnet/archive/2012/07/20/the-net-framework-4-5-includes-new-garbage-collector-enhancements-for-client-and-server-apps.aspx>The .NET Framework 4.5 includes new garbage collector enhancements for client and server apps</a>.</p><hr><ul class=pager><li class=previous><a href=/post/2013-10-20-gethashcode-dein-freund-und-sorgenkind/ data-toggle=tooltip data-placement=top title="GetHashCode dein Freund und Sorgenkind">&larr;
Previous Post</a></li><li class=next><a href=/post/2013-11-27-debugging-von-performance-problemen-in-net/ data-toggle=tooltip data-placement=top title="Debugging von Performance Problemen in .NET">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:this-is@alexander-koepke.de><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/alexander-k%c3%b6pke-3222a21b7/><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/9474615/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=@koepalex@dotnet.social><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>