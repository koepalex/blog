<!doctype html><html lang=de-de><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content><meta property="og:type" content="article"><meta property="og:image" content="https://www.alexander-koepke.de//koepalex.logo.gif"><meta property="twitter:image" content="https://www.alexander-koepke.de//koepalex.logo.gif"><meta name=title content="Einiges über IDisposable"><meta property="og:title" content="Einiges über IDisposable"><meta property="twitter:title" content="Einiges über IDisposable"><meta name=description content="Technical articles, the Universe and the all the rest"><meta property="og:description" content="Technical articles, the Universe and the all the rest"><meta property="twitter:description" content="Technical articles, the Universe and the all the rest"><meta property="twitter:card" content="summary"><meta name=keyword content><link rel="shortcut icon" href=/img/favicon.ico><title>Einiges über IDisposable | </title><link rel=canonical href=/post/2011-06-07-something-idisposable/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script><script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/></a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/ai/ml/>ai/ml</a></li><li><a href=/categories/dotnet/>dotnet</a></li><li><a href=/categories/miscellaneous/>miscellaneous</a></li><li><a href=/categories/opc-ua/>opc ua</a></li><li><a href=/categories/til/>til</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><header class=intro-header style=background-image:url(/koepalex.logo.gif)><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=site-heading><h1></h1><span class=subheading></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-1
col-md-8 col-md-offset-1
col-sm-12
col-xs-12
post-container"><p>Das Standard Interface IDisposable welches  zur &ldquo;Freigabe&rdquo; von Ressourcen in .Net dient ist recht Einfach:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>interface</span> <span style=color:#50fa7b>IDisposable</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>void</span> Dispose();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Nur dieses Interface zu Implementieren reicht in vielen Fällen nicht aus. Es gibt z.B. einen FxCop Fehler <a href="http://msdn.microsoft.com/en-us/library/ms244737(v=vs.80).aspx">Implement IDisposable correctly</a>, dieser erscheint u.a. bei non-sealed Klassen welche keinen Medthode mit der Signatur protected virtual Dispose(bool) besitzen.  IDisposable zu Implementieren wird nötig wenn man:</p><ol><li>unmanged (native) Ressourcen lädt um diese wieder freizugeben</li><li>managed Felder besitzt, welche wiederum IDisposable implementieren</li></ol><p>Im folgenden Beispiel zeigt eine (nach FxCop komplette Implementierung) einer Basis-Klasse  und einer Kind-Klasse:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ManagedBasisClassI</span> : IDisposable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	~ManagedBasisClassI()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Dispose(<span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Dispose()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Dispose(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>virtual</span> <span style=color:#ff79c6>void</span> Dispose(<span style=color:#8be9fd>bool</span> disposing)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (disposing)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#6272a4>//clean managed ressources</span>
</span></span><span style=display:flex><span>			GC.SuppressFinalize(<span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#6272a4>//clean unmanaged ressources</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ManagedChildClass</span> : ManagedBasisClassI
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd;font-style:italic>override</span> <span style=color:#ff79c6>void</span> Dispose(<span style=color:#8be9fd>bool</span> disposing)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>try</span>
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (disposing)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#6272a4>//clean managed ressources</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#6272a4>//clean unmanaged ressources</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>finally</span>
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>base</span>.Dispose(disposing);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Man darf jetzt nicht auf die Idee kommen, dass IDisposable im .Net Framework dazu dient den Lebenszyklus von Objekten zu steuern. Objekte existieren mindestens so lange, wie eine Referenz auf sie besteht (Ausnahme: WeakReference). Bitte das &ldquo;mindestens&rdquo; beachten, denn wann ein Objekt aus dem Speicher verschwindet, auf das keine Referenz mehr existiert entscheidet nur der Garbage Collector. Zugriffe auf Objekte die noch existieren, aber bei denen Dispose bereits aufgerufen wurde, enden oft in Exceptions. Die Klasse Bitmap wirft in solchen Fällen eine  ArgumentException “Ungültiger Parameter“.  Eigene Klassen sollte man daher eine Weitere public Property erhalten, durch welche man Abfragen kann ob das Objekt bereits Disposed wurde oder gerade Disposed wird. In solchen Fällen, darf man auf das Objekt nicht mehr Zugreifen, sondern muss es Neuanlegen.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ManagedBasisClassII</span> : IDisposable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	~ManagedBasisClassII()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Dispose(<span style=color:#ff79c6>false</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Dispose()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Dispose(<span style=color:#ff79c6>true</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#ff79c6>virtual</span> <span style=color:#ff79c6>void</span> Dispose(<span style=color:#8be9fd>bool</span> disposing)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (Disposing) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ObjectDisposedException(<span style=color:#ff79c6>this</span>.ToString());
</span></span><span style=display:flex><span>		Disposing = <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (disposing)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#6272a4>//clean managed ressources</span>
</span></span><span style=display:flex><span>			GC.SuppressFinalize(<span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#6272a4>//clean unmanaged ressources</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>bool</span> Disposing { <span style=color:#ff79c6>get</span>; <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Diese Lösung trägt für eigene Objekte sehr gut. Problematisch wird es bei Objekten von Klassen des .Net Framework selbst. Der nächste Quelltext stellt eine kleines Dummy Programm dar, indem 2 Clients Zugriff auf ein und das selbe <a href=http://msdn.microsoft.com/en-us/library/system.drawing.image.aspx>Bitmap</a> Objekt möchten. Client1 ruft Dispose am Bitmap auf nach Verwendung (was auch sehr gut ist). Client2 bekommt beim Versuch das Bitmap aus einem Pool zu laden, die Referenz auf das alte Objekt, beim Zugriff auf eine der Methoden des Objektes kommt es zum Absturz des Programmes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Program</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>void</span> Main(<span style=color:#8be9fd>string</span>[] args)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		PicturePool pool = <span style=color:#ff79c6>new</span> PicturePool();
</span></span><span style=display:flex><span>		ClientI client1 = <span style=color:#ff79c6>new</span> ClientI(pool);
</span></span><span style=display:flex><span>		client1.Run();
</span></span><span style=display:flex><span>		ClientII client2 = <span style=color:#ff79c6>new</span> ClientII(pool);
</span></span><span style=display:flex><span>		client2.Run();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ClientI</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> PicturePool m_Pool;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> ClientI(PicturePool pool)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(pool == <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ArgumentNullException(<span style=color:#f1fa8c>&#34;pool&#34;</span>);
</span></span><span style=display:flex><span>		m_Pool = pool;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Run()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Bitmap pic = m_Pool[<span style=color:#f1fa8c>@&#34;D:\\tmp\\bild.jpg&#34;</span>];
</span></span><span style=display:flex><span>		Console.WriteLine(String.Format(<span style=color:#f1fa8c>&#34;Height:{0}&#34;</span>, pic.Height));
</span></span><span style=display:flex><span>		Console.WriteLine(String.Format(<span style=color:#f1fa8c>&#34;Width:{0}&#34;</span>, pic.Width));
</span></span><span style=display:flex><span>		Console.WriteLine(String.Format(<span style=color:#f1fa8c>&#34;Pixelformat:{0}&#34;</span>, pic.PixelFormat));
</span></span><span style=display:flex><span>		pic.Dispose();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ClientII</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> PicturePool m_Pool;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> ClientII(PicturePool pool)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(pool == <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ArgumentNullException(<span style=color:#f1fa8c>&#34;pool&#34;</span>);
</span></span><span style=display:flex><span>		m_Pool = pool;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Run()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Bitmap pic = m_Pool[<span style=color:#f1fa8c>@&#34;D:\\tmp\\bild.jpg&#34;</span>];
</span></span><span style=display:flex><span>		<span style=color:#6272a4>//ArgumentException&#34;UngültigerParameter&#34;_</span>
</span></span><span style=display:flex><span>		Image thumbnail = pic.GetThumbnailImage(<span style=color:#bd93f9>200</span>, <span style=color:#bd93f9>200</span>, <span style=color:#ff79c6>null</span>, IntPtr.Zero);
</span></span><span style=display:flex><span>		thumbnail.Save(<span style=color:#f1fa8c>@&#34;D:\\tmp\\bild_thumbnail.jpg&#34;</span>);                 
</span></span><span style=display:flex><span>		pic.Dispose();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>PicturePool</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, WeakReference&gt; m_Pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> PicturePool()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		m_Pool = <span style=color:#ff79c6>new</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, WeakReference&gt;();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> Bitmap <span style=color:#ff79c6>this</span>[<span style=color:#8be9fd>string</span> path]
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>get</span>
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span>(String.IsNullOrEmpty(path)) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ArgumentNullException(<span style=color:#f1fa8c>&#34;path&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> GetPicture(path);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> Bitmap GetPicture(<span style=color:#8be9fd>string</span> path)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(!m_Pool.ContainsKey(path) || !m_Pool[path].IsAlive || m_Pool[path].Target == <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			m_Pool[path] = <span style=color:#ff79c6>new</span> WeakReference(<span style=color:#ff79c6>new</span> Bitmap(path));
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#6272a4>//WeakReference.IsAlvie kann true sein aber das Target bereits Disposed</span>
</span></span><span style=display:flex><span>		<span style=color:#6272a4>//was kann man tun?</span>
</span></span><span style=display:flex><span>		Return m_Pool[path].Target <span style=color:#ff79c6>as</span> Bitmap;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Da es nicht Möglich ist zu ermitteln ob das Bitmap-Objekt bereits Disposed ist kommt es zu dem oberen Absturz. Eine einfache Lösung  ist ein Wrapper um das Bitmap Objekt (eine Ableitung kann es nicht sein, da die Klasse Bitmap Sealed ist). Der PicturePool gibt nur noch Referenzen auf einen BitmapWrapper herraus und fragt am BitmapWrapper ob er Disposed ist, wenn ja muss der Wrapper für dieses Bitmap neu geladen werden.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Program</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>void</span> Main(<span style=color:#8be9fd>string</span>[] args)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		PicturePool2 pool = <span style=color:#ff79c6>new</span> PicturePool2();
</span></span><span style=display:flex><span>		ClientIa client1 = <span style=color:#ff79c6>new</span> ClientIa(pool);
</span></span><span style=display:flex><span>		client1.Run();
</span></span><span style=display:flex><span>		ClientIIa client2 = <span style=color:#ff79c6>new</span> ClientIIa(pool);
</span></span><span style=display:flex><span>		client2.Run();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ClientIa</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> PicturePool2 m_Pool;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> ClientIa(PicturePool2 pool)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(pool == <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ArgumentNullException(<span style=color:#f1fa8c>&#34;pool&#34;</span>);
</span></span><span style=display:flex><span>		m_Pool = pool;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Run()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		BitmapWrapper wrapper = m_Pool[<span style=color:#f1fa8c>@&#34;D:\\tmp\\bild.jpg&#34;</span>];
</span></span><span style=display:flex><span>		Console.WriteLine(String.Format(<span style=color:#f1fa8c>&#34;Height:{0}&#34;</span>, wrapper.Bitmap.Height));
</span></span><span style=display:flex><span>		Console.WriteLine(String.Format(<span style=color:#f1fa8c>&#34;Width:{0}&#34;</span>, wrapper.Bitmap.Width));
</span></span><span style=display:flex><span>		Console.WriteLine(String.Format(<span style=color:#f1fa8c>&#34;Pixelformat:{0}&#34;</span>, wrapper.Bitmap.PixelFormat));
</span></span><span style=display:flex><span>		wrapper.Dispose();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ClientIIa</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> PicturePool2 m_Pool;
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> ClientIIa(PicturePool2 pool)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(pool == <span style=color:#ff79c6>null</span>) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ArgumentNullException(<span style=color:#f1fa8c>&#34;pool&#34;</span>);
</span></span><span style=display:flex><span>		m_Pool = pool;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Run()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		BitmapWrapper wrapper = m_Pool[<span style=color:#f1fa8c>@&#34;D:\\tmp\\bild.jpg&#34;</span>];
</span></span><span style=display:flex><span>		Image thumbnail = wrapper.Bitmap.GetThumbnailImage(<span style=color:#bd93f9>200</span>, <span style=color:#bd93f9>200</span>, <span style=color:#ff79c6>null</span>, IntPtr.Zero);
</span></span><span style=display:flex><span>		thumbnail.Save(<span style=color:#f1fa8c>@&#34;D:\\tmp\\bild_thumbnail.jpg&#34;</span>);
</span></span><span style=display:flex><span>        wrapper.Dispose();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>PicturePool2</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, WeakReference&gt; m_Pool;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> PicturePool2()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		m_Pool = <span style=color:#ff79c6>new</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, WeakReference&gt;();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> BitmapWrapper <span style=color:#ff79c6>this</span>[<span style=color:#8be9fd>string</span> path]
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>get</span>
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span>(String.IsNullOrEmpty(path)) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ArgumentNullException(<span style=color:#f1fa8c>&#34;path&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> GetPicture(path);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>private</span> BitmapWrapper GetPicture(<span style=color:#8be9fd>string</span> path)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(!m_Pool.ContainsKey(path) || !m_Pool[path].IsAlive || m_Pool[path].Target == <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			m_Pool[path] = <span style=color:#ff79c6>new</span> WeakReference(<span style=color:#ff79c6>new</span> BitmapWrapper(path));
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			BitmapWrapper pic = m_Pool[path].Target <span style=color:#ff79c6>as</span> BitmapWrapper;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span>(pic.Disposed)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				m_Pool[path] = <span style=color:#ff79c6>new</span> WeakReference(<span style=color:#ff79c6>new</span> BitmapWrapper(path));
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> m_Pool[path].Target <span style=color:#ff79c6>as</span> BitmapWrapper;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>sealed</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>BitmapWrapper</span> : IDisposable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> BitmapWrapper(<span style=color:#8be9fd>string</span> path)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span>(String.IsNullOrEmpty(<span style=color:#f1fa8c>&#34;path&#34;</span>)) <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> ArgumentNullException(<span style=color:#f1fa8c>&#34;path&#34;</span>);
</span></span><span style=display:flex><span>		Bitmap = <span style=color:#ff79c6>new</span> Bitmap(path);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>bool</span> Disposed { <span style=color:#ff79c6>get</span>; <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> Bitmap Bitmap { <span style=color:#ff79c6>get</span>; <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Dispose()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Disposed = <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>		Bitmap.Dispose();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Dies ist kein All-Heil-Mittel, sollte jemand wrapper.Bitmap.Dispose() aufrufen, kommt es zum alten Problem.  Doch für viele Szenarien, ist diese Variante absolut ausreichend. Die Königs-Lösung ist ein komplett Wrapper für das Bitmap dieser</p><ul><li>Leitet sich von System.Drawing.Image ab und ist sealed</li><li>Beinhaltet einen privaten Member vom Typ System.Drawing.Bitmap</li><li>Implementiert alle public Methoden von Bitmap und Image und leitet diese an den privaten Member weiter (notfalls mit new Überschreiben)</li><li>Implementiert IDisposable und die public Property Disposed</li></ul><p>Diesen Komplett Wrapper zu schreiben ist etwas aufwendig, lohnt sich irgendwann (kommt auf die Größe und die Laufzeit des Projektes an).</p><p>Ich hoffe das dieser Blog Eintrag etwas weiterhelfen konnte. :-D</p></div><div class="col-lg-3 col-lg-offset-0
col-md-3 col-md-offset-0
col-sm-12
col-xs-12
sidebar-container"><section class="visible-md visible-lg"><div class=short-about><a href=/about><img src=/avatar.jpg alt=avatar style=cursor:pointer></a><p>Software Architect in the Agile Age, with focus on Industrial IoT</p><ul class=list-inline><li><a href=mailto:this-is@alexander-koepke.de><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/alexander-k%c3%b6pke-3222a21b7/><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/9474615/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=@koepalex@dotnet.social><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li></ul></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:this-is@alexander-koepke.de><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/alexander-k%c3%b6pke-3222a21b7/><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/9474615/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=@koepalex@dotnet.social><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 2025<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>