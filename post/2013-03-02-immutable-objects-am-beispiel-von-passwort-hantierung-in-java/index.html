<!doctype html><html lang=de-de><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content><meta property="og:type" content="article"><meta property="og:image" content="https://koepalex.github.io/blog//koepalex.logo.gif"><meta property="twitter:image" content="https://koepalex.github.io/blog//koepalex.logo.gif"><meta name=title content="Immutable Objects am Beispiel von Passwort Hantierung in Java"><meta property="og:title" content="Immutable Objects am Beispiel von Passwort Hantierung in Java"><meta property="twitter:title" content="Immutable Objects am Beispiel von Passwort Hantierung in Java"><meta name=description content="Technischer Artikel, das Universum und der ganze Rest"><meta property="og:description" content="Technischer Artikel, das Universum und der ganze Rest"><meta property="twitter:description" content="Technischer Artikel, das Universum und der ganze Rest"><meta property="twitter:card" content="summary"><meta name=keyword content><link rel="shortcut icon" href=/blog/img/favicon.ico><title>Immutable Objects am Beispiel von Passwort Hantierung in Java | </title><link rel=canonical href=/blog/post/2013-03-02-immutable-objects-am-beispiel-von-passwort-hantierung-in-java/><link rel=stylesheet href=/blog/css/bootstrap.min.css><link rel=stylesheet href=/blog/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/blog/css/zanshang.css><link rel=stylesheet href=/blog/css/font-awesome.all.min.css><script src=/blog/js/jquery.min.js></script><script src=/blog/js/bootstrap.min.js></script><script src=/blog/js/hux-blog.min.js></script><script src=/blog/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/></a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/blog>All Posts</a></li><li><a href=/blog/categories/allgemein/>allgemein</a></li><li><a href=/blog/categories/c-net/>c-net</a></li><li><a href=/blog/categories/java/>java</a></li><li><a href=/blog/categories/macos/>macos</a></li><li><a href=/blog/categories/ubuntu/>ubuntu</a></li><li><a href=/blog/categories/zfs/>zfs</a></li><li><a href=/blog/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/blog/koepalex.logo.gif)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/immutable title=immutable>immutable
</a><a class=tag href=/tags/java-2 title=java-2>java-2
</a><a class=tag href=/tags/passwort title=passwort>passwort</a></div><h1>Immutable Objects am Beispiel von Passwort Hantierung in Java</h1><h2 class=subheading></h2><span class=meta>Posted by
on
Saturday, March 2, 2013</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>In Java sind Strings „Immutable Objects“ (unveränderliche Objekte),<br>dass bedeutet sie werden zur Laufzeit nicht mehr geändert.  Immutables Objects haben viele Vorteile:</p><ul><li>im Allgemeinen ist es einfach möglich zu parallelisieren</li><li>Implementierung von Undo- und Redo-Funktionalitäten sind normalerweise einfach (z.B. mittels Memento-Pattern)</li><li>James Gosling (einer der Erfinder von Java), gibt zusätzlich an, dass bei Immutable Objects es grundsätzlich möglich ist, Ergebnisse zu Cachen und das die Sicherheit wird erhöht. (vgl. <a href=https://www.artima.com/intv/gosling313.html>https://www.artima.com/intv/gosling313.html</a> )</li></ul><p>Sicherheit ist ein gutes Stichwort, denn Immutable Objects können auch Sicherheitsprobleme mit sich bringen. Schauen wir uns einmal Passwörter bei Java an. Diese sollten niemals in einem String gespeichert werden, da sie solange der String im Speicher existiert, im Klartext im Speicher stehen. Die allgemeine Empfehlung in verschiedenen Security Guides lautet daher Passwörter nur als Char-Array zu hantieren und sobald man das Passwort nicht mehr benötigt, den Inhalt dieses Array zu überschreiben. Überschreiben funktioniert mit Immutable Objects nicht, was ein Passwort in einem String zu einem Sicherheitsrisiko werden lässt.</p><p>Die Java-Entwickler haben dies natürlich erkannt und u.a. die Methode getText() des JPasswordFields (mit ihren zwei Überladungen) wurden vor geraumer Zeit auf &ldquo;deprecated&rdquo; (obsolet) gesetzt und sollten nicht mehr Verwendet werden. Als Ersatz wurde die Methode getPassword(), welche ein Char-Array zurückliefert, hinzugefügt.So weit, so gut, doch wenn man in die Verlegenheit kommt, in einem JPasswordField ein Passwort zu setzen findet man nur die von JTextComponent geerbte Methode setText(). Diese Methode bekommt als Übergabeparameter einen String, was auch verständlich ist, da JTextComponent die Vaterklasse für alle Text-Controls ist. Die Methode sollte somit nicht verwendet werden. Als Lösung kann man so tun, als ob der Benutzer etwas in das Tastenfeld eingibt und die Zeichen einzeln an das JPasswordField senden:</p><blockquote><p><strong>char</strong>[] password = getPasswordInternal();</p><p><strong>for</strong> (<strong>int</strong> i = 0; i&lt; password.length; i++) {</p><p>  passwordField.dispatchEvent(<strong>new</strong> KeyEvent(passwordField,</p><p>    KeyEvent.<em>KEY_TYPED</em>, System.<em>currentTimeMillis</em>(),</p><p>    0, KeyEvent.<em>VK_UNDEFINED</em>, password[i]));</p><p>}<br>Arrays.<em>fill</em>(password, &lsquo;0&rsquo;);</p></blockquote><p>Ich habe öfter die Frage gehört, warum man ein Passwort automatisch in ein Passwort-Control setzen sollte, es dient ja dazu da um Passworteingaben, von einem Benutzer zu bekommen. So finde ich die Antwort, weil man einen Betriebssystemunabhängigen PasswordManager bauen will oder weil es einfach den Anforderungen entspricht, logisch.</p><p>PasswordManager bieten meist auch die Funktionalität, das Passwort in die Zwischenablage zu kopieren und diese automatisch nach ein paar Sekunden, wieder zu säubern. In Java funktioniert der Zugriff auf die Zwischenablage über die Klasse java.awt.Toolkit.</p><blockquote><p>Toolkit.<em>getDefaultToolkit</em>().getSystemClipboard().setContents(<strong>new</strong> StringSelection(<strong>new</strong> String(password)), <strong>null</strong>);</p></blockquote><p>Doch diese Implementierung ist natürlich nicht akzeptabel, da wieder ein String verwendet wird. Jeder Versuch die StringSelection Klasse mit einer eigenen Transferable Implementierung (siehe <a href=http://docs.oracle.com/javase/1.4.2/docs/api/java/awt/datatransfer/Transferable.html>http://docs.oracle.com/javase/1.4.2/docs/api/java/awt/datatransfer/Transferable.html</a> ), die auf Basis eines Char-Arrays arbeitet, zu ersetzen schlugen bei mir fehl. Als Erläuterung, durch die Vaterklasse Transferable erbt man u.a. die Methode getTransferDataFlavors, bei welcher man ein Array von Unterstützen DataFlavors zurückliefern muss. Jedes Mal, wenn ich einen DataFlavor der sich auf Text oder UnicodeText bezieht, zurück geliefert habe, wurde im Verlauf der setContents Methode, der Rückgabewert der Methode getTransferData auf String gecastet. Was bei einem Char-Array nicht funktioniert. Meine Lösung für dieses Problem ist aufwendig. Und zwar dass via Java Native Access (JNA), für jedes Betriebssystem (Windows, Linux, MacOS, Solaris ) auf die nativen Funktionen zugegriffen wird. Für Windows könnte eine Implementierung wie folgt aussehen:</p><blockquote><p><strong>interface</strong> Kernel32Lib <strong>extends</strong> StdCallLibrary</p><p>{</p><p>  Pointer GlobalLock(Pointer hResult);</p><p>  Pointer GlobalUnlock(Pointer hResult);</p><p>  Pointer GlobalAlloc(<strong>int</strong> uFlags, <strong>int</strong> dwBytes);</p><p>  Pointer GlobalFree(Pointer hResult);</p><p>}</p><p><strong>interface</strong> User32Lib <strong>extends</strong> StdCallLibrary</p><p>{</p><p>  <strong>boolean</strong> OpenClipboard(Pointer hInstance);</p><p>  <strong>boolean</strong> EmptyClipboard();</p><p>  Pointer SetClipboardData(<strong>int</strong> uFormat, Pointer hMem);</p><p>  <strong>boolean</strong> CloseClipboard();</p><p>}</p><p><strong>class</strong> Kernel32Wrapper {</p><p>  <strong>private</strong> Kernel32Lib _Instance;</p><p>  <strong>private</strong> Pointer _Memory;</p><p>  <strong>private</strong> Pointer _LockedMemory;</p><p>  <strong>private</strong> <strong>final</strong> <strong>static</strong> <strong>int</strong> <em>GMEM_MOVEABLE</em> = 0x2;</p><p>  <strong>private</strong> <strong>final</strong> <strong>static</strong> <strong>int</strong> <em>GMEM_ZEROINIT</em> = 0x40;</p><p>Kernel32Wrapper() {</p><p>  _Instance = (Kernel32Lib) Native.<em>loadLibrary</em><br>     (&ldquo;Kernel32&rdquo;, Kernel32Lib.<strong>class</strong>);</p><p>}</p><p><strong>public</strong> Pointer allocate(<strong>int</strong> size) {</p><p>  _Memory = _Instance.GlobalAlloc(<em>GMEM_MOVEABLE</em> |<br>    <em>GMEM_ZEROINIT</em>, size);</p><p>  <strong>if</strong> (_Memory == <strong>null</strong>) {</p><p>    <strong>int</strong> errno = Native.<em>getLastError</em>();</p><p>    System.<em>out</em>.println(errno);</p><p>  }</p><p>  <strong>return</strong> _Memory;</p><p>}</p><p><strong>public</strong> <strong>boolean</strong> free() {</p><p>  <strong>boolean</strong> result = <strong>false</strong>;</p><p>  <strong>if</strong> (_Memory != <strong>null</strong>) {</p><p>    result = _Instance.GlobalFree(_Memory) != <strong>null</strong>;</p><p>    _Memory = <strong>null</strong>;</p><p>  }</p><p>  <strong>return</strong> result;</p><p>}</p><p><strong>public</strong> Pointer lock() {</p><p>  _LockedMemory = _Instance.GlobalLock(_Memory);</p><p>  <strong>if</strong> (_LockedMemory == <strong>null</strong>) {</p><p>    <strong>int</strong> errno = Native.<em>getLastError</em>();</p><p>    System.<em>out</em>.println(errno);</p><p>  }</p><p>  <strong>return</strong> _LockedMemory;</p><p>}</p><p><strong>public</strong> <strong>void</strong> unlock() {</p><p>  <strong>if</strong> (_LockedMemory != <strong>null</strong>) {</p><p>  _Instance.GlobalUnlock(_LockedMemory);</p><p>  _LockedMemory = <strong>null</strong>;</p><p>}</p><p>}</p><p>}</p><p><strong>class</strong> Win32ClipboardService {</p><p><strong>private</strong> <strong>final</strong> <strong>static</strong> <strong>int</strong> <em>CF_UNICODETEXT</em> = 13;</p><p><strong>private</strong> User32Lib _Instance;</p><p><strong>private</strong> Kernel32Wrapper _Kernel32;</p><p>Win32ClipboardService () {</p><p>  _Instance = (User32Lib) Native.<em>loadLibrary</em>(&ldquo;User32&rdquo;,  User32Lib.<strong>class</strong>);</p><p>  _Instance.OpenClipboard(<strong>null</strong>);</p><p>  _Kernel32 = <strong>new</strong> Kernel32Wrapper();</p><p>}</p><p><strong>public</strong> <strong>void</strong> setClipboard(<strong>char</strong>[] password) {</p><p>  <strong>byte</strong>[] buff = <em>convertCharArrayToByteArray</em>(password);</p><p>  <strong>int</strong> size = buff.length + 2;</p><p>  Pointer hResult = _Kernel32.allocate(size);</p><p>  <strong>if</strong> (hResult != <strong>null</strong>)</p><p>  {</p><p>    Pointer globalMem = _Kernel32.lock();</p><p>    <strong>if</strong> (globalMem != <strong>null</strong>)</p><p>    {</p><p>      ByteBuffer bBuff = globalMem.getByteBuffer(0, buff.length);</p><p>        bBuff.put(buff);</p><p>      _Kernel32.unlock();</p><p>      globalMem = <strong>null</strong>;</p><p>      _Instance.SetClipboardData(<em>CF_UNICODETEXT</em>, hResult);</p><p>    }</p><p>  }</p><p>  Arrays.<em>fill</em>(buff, 0, buff.length, (<strong>byte</strong>)0);</p><p>}</p><p><strong>public</strong> <strong>void</strong> clearClipboard() {</p><p>  _Instance.EmptyClipboard();</p><p>}</p><p><strong>public</strong> <strong>void</strong> close() {</p><p>  _Instance.CloseClipboard();</p><p>  _Kernel32.free();</p><p>}</p><p>private <strong>static</strong> <strong>byte</strong>[] convertCharArrayToByteArray(<strong>char</strong>[] password) {</p><p>  <strong>byte</strong>[] result = <strong>new</strong> <strong>byte</strong> [password.length * 2];</p><p>  <strong>for</strong> (<strong>int</strong> i = 0; i &lt; password.length; i++) {</p><p>    result[i * 2] = (<strong>byte</strong>) password[i];</p><p>    result[i * 2 + 1]=(<strong>byte</strong>) (password[i] &#187; 8);</p><p>  }</p><p>  <strong>return</strong> result;</p><p>}</p><p>}</p></blockquote><hr><ul class=pager><li class=previous><a href=/blog/post/2012-10-14-ermitteln-des-pid-processidentifier-des-vaterprozesses/ data-toggle=tooltip data-placement=top title="Ermitteln des PID (Processidentifier) des Vaterprozesses">&larr;
Previous Post</a></li><li class=next><a href=/blog/post/2013-08-24-eindruck-und-gedanken-zu-mac-os-x/ data-toggle=tooltip data-placement=top title="Eindruck und Gedanken zu Mac OS X">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:this-is@alexander-koepke.de><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/alexander-k%c3%b6pke-3222a21b7/><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/9474615/koepalex><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=@koepalex@dotnet.social><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/blog/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>